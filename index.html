<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Escalas da Igreja</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <style>
    :root{
      --azul-escuro:#0a2540;
      --azul:#1e40af;
      --azul-claro:#e0ecff;
      --cinza:#f4f6f8;
    }

    body{
      margin:0;
      font-family:'Segoe UI',Roboto,sans-serif;
      background:var(--cinza);
    }

    header{
      background:linear-gradient(135deg,var(--azul-escuro),var(--azul));
      color:#fff;
      padding:20px;
      text-align:center;
    }

    main{
      max-width:1100px;
      margin:30px auto;
      padding:20px;
    }

    .card{
      background:#fff;
      border-radius:12px;
      padding:20px;
      box-shadow:0 10px 25px rgba(0,0,0,.05);
      margin-bottom:30px;
    }

    h2{color:var(--azul);margin-top:0}

    button{
      background:var(--azul);
      color:#fff;
      border:none;
      border-radius:8px;
      padding:8px 14px;
      cursor:pointer;
    }
    button:hover{background:#172554}

    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid #ddd}
    th{background:var(--azul-claro)}

    .fc{
      background:#fff;
      border-radius:12px;
      padding:10px;
    }

    .fc-daygrid-event{
      z-index:5;
      cursor:pointer;
    }
    .fc-daygrid-day-frame{
      position:relative;
      z-index:1;
    }

    /* MODAL */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.5);
      justify-content:center;
      align-items:center;
      z-index:9999;
    }

    .modal-content{
      background:#fff;
      border-radius:14px;
      padding:20px;
      width:90%;
      max-width:420px;
      position:relative;
    }

    .modal-content h3{
      margin-top:0;
      color:var(--azul);
      text-align:center;
    }

    .edit-btn{
      position:absolute;
      top:12px;
      right:12px;
      background:none;
      border:none;
      font-size:18px;
      cursor:pointer;
      color:var(--azul);
    }

    .form-group{
      display:flex;
      flex-direction:column;
      gap:5px;
      margin-bottom:12px;
    }

    .form-group label{
      font-size:13px;
      color:#555;
    }

    .form-group input{
      padding:10px;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:14px;
    }

    .readonly input{
      background:#f1f5f9;
    }

    .modal-actions{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:15px;
    }

    .btn-danger{
      background:#b91c1c;
    }
    .btn-danger:hover{
      background:#7f1d1d;
    }
  </style>
</head>
<body>

<header>
  <h1>üìÖ Escalas da Igreja</h1>
</header>

<main>
  <div class="card">
    <button onclick="mostrarTabela()">Tabela</button>
    <button onclick="mostrarCalendario()">Calend√°rio</button>
  </div>

  <div class="card" id="secaoTabela">
    <h2>üìã Pr√≥ximas Escalas</h2>
    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Pregador</th>
          <th>Cantor</th>
          <th>Sonoplasta</th>
        </tr>
      </thead>
      <tbody id="listaEscalas"></tbody>
    </table>
  </div>

  <div class="card" id="secaoCalendario" style="display:none">
    <h2>üóìÔ∏è Calend√°rio</h2>
    <div id="calendar"></div>
  </div>
</main>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-content readonly" id="modalContent">
    <h3 id="modalTitulo">Escala</h3>
    <button class="edit-btn" id="btnEditar" title="Editar">‚úèÔ∏è</button>

    <div class="form-group">
      <label>Data</label>
      <input type="date" id="mData">
    </div>

    <div class="form-group">
      <label>Pregador</label>
      <input type="text" id="mPregador">
    </div>

    <div class="form-group">
      <label>Cantor</label>
      <input type="text" id="mCantor">
    </div>

    <div class="form-group">
      <label>Sonoplasta</label>
      <input type="text" id="mSonoplasta">
    </div>

    <div class="form-group">
      <label>WhatsApp</label>
      <input type="text" id="mTelefone">
    </div>

    <div class="modal-actions">
      <button onclick="salvarEscala()">Salvar</button>
      <button class="btn-danger" onclick="excluirEscala()">Excluir</button>
      <button onclick="fecharModal()">Fechar</button>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAUQeo8pNtkySgK55Bik59sHwvAaxVsS6w",
    authDomain: "escala-santa-helena.firebaseapp.com",
    projectId: "escala-santa-helena",
    storageBucket: "escala-santa-helena.firebasestorage.app",
    messagingSenderId: "853456405347",
    appId: "1:853456405347:web:9b85caee37bbf5a5c10956"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const lista = document.getElementById('listaEscalas');
  const modal = document.getElementById('modal');
  const modalContent = document.getElementById('modalContent');
  const btnEditar = document.getElementById('btnEditar');
  const modalTitulo = document.getElementById('modalTitulo');

  const mData = document.getElementById('mData');
  const mPregador = document.getElementById('mPregador');
  const mCantor = document.getElementById('mCantor');
  const mSonoplasta = document.getElementById('mSonoplasta');
  const mTelefone = document.getElementById('mTelefone');

  let calendar;
  let escalaIdAtual = null;

  async function carregarEscalas(){
    lista.innerHTML='';
    const snap = await db.collection('escalas').orderBy('data').get();
    const eventos=[];

    snap.forEach(doc=>{
      const e = doc.data();
      lista.innerHTML += `
        <tr>
          <td>${e.data}</td>
          <td>${e.pregador}</td>
          <td>${e.cantor||'-'}</td>
          <td>${e.sonoplasta||'-'}</td>
        </tr>`;
      eventos.push({
        title:'üé§ '+e.pregador,
        start:e.data,
        extendedProps:{...e,id:doc.id}
      });
    });

    if(calendar){
      calendar.removeAllEvents();
      calendar.addEventSource(eventos);
    }
  }

  function mostrarCalendario(){
    secaoTabela.style.display='none';
    secaoCalendario.style.display='block';

    if(!calendar){
      calendar = new FullCalendar.Calendar(document.getElementById('calendar'),{
        initialView:'dayGridMonth',
        locale:'pt-br',
        dateClick:info=>abrirModal({data:info.dateStr}),
        eventClick:info=>abrirModal(info.event.extendedProps)
      });
      calendar.render();
    }
    carregarEscalas();
  }

  function mostrarTabela(){
    secaoCalendario.style.display='none';
    secaoTabela.style.display='block';
  }

  function abrirModal(dados={}){
    escalaIdAtual = dados.id || null;
    modalTitulo.innerText = escalaIdAtual ? 'Detalhes da Escala' : 'Nova Escala';

    mData.value = dados.data || '';
    mPregador.value = dados.pregador || '';
    mCantor.value = dados.cantor || '';
    mSonoplasta.value = dados.sonoplasta || '';
    mTelefone.value = dados.telefone || '';

    if(escalaIdAtual){
      setReadonly(true);
      btnEditar.style.display='block';
    }else{
      setReadonly(false);
      btnEditar.style.display='none';
    }

    modal.style.display='flex';
  }

  function setReadonly(valor){
    modalContent.classList.toggle('readonly',valor);
    [mData,mPregador,mCantor,mSonoplasta,mTelefone]
      .forEach(i=>i.disabled = valor);
  }

  btnEditar.onclick = ()=>{
    setReadonly(false);
    modalTitulo.innerText='Editar Escala';
  };

  async function salvarEscala(){
    const dados={
      data:mData.value,
      pregador:mPregador.value,
      cantor:mCantor.value,
      sonoplasta:mSonoplasta.value,
      telefone:mTelefone.value
    };

    if(escalaIdAtual){
      await db.collection('escalas').doc(escalaIdAtual).update(dados);
    }else{
      await db.collection('escalas').add(dados);
    }

    fecharModal();
    carregarEscalas();
  }

  async function excluirEscala(){
    if(!escalaIdAtual) return;
    if(confirm('Deseja excluir esta escala?')){
      await db.collection('escalas').doc(escalaIdAtual).delete();
      fecharModal();
      carregarEscalas();
    }
  }

  function fecharModal(){
    modal.style.display='none';
    escalaIdAtual=null;
  }

  carregarEscalas();
</script>

</body>
</html>
